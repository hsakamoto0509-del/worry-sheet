<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‚©ã¿äº‹â†’æ„Ÿæƒ…â†’æœ›ã‚€çŠ¶æ…‹â†’è§£æ±ºç­–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥URLå¯¾å¿œï¼‰</title>
  <style>
    :root { --bg:#f7f7f7; --fg:#111; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --accent:#111; --accentText:#fff; --ok:#065f46; --okbg:#ecfdf5; --warn:#4338ca; --warnbg:#eef2ff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif; }
    .container { max-width:960px; margin:0 auto; padding:16px; }
    h1 { font-size: 20px; margin: 0 0 4px; }
    .muted { color: var(--muted); font-size: 12px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:12px 0; }
    .spacer { flex:1; }
    .btn { appearance:none; border-radius:12px; font-size:14px; padding:10px 14px; border:1px solid var(--border); background:#fff; color:var(--fg); cursor:pointer; }
    .btn[disabled]{ opacity:.6; pointer-events:none; }
    .btn.primary { background:var(--accent); color:var(--accentText); border-color:var(--accent); }
    .btn.danger { border-color:#fecaca; color:#b91c1c; }
    .input, .select, .textarea { border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; width:100%; background:#fff; }
    .textarea { min-height: 84px; resize: vertical; }
    .progress { width:100%; height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar { height:100%; background:#111; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .card-h { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); }
    .chip { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); }
    .chip.done { background:#111; color:#fff; border-color:#111; }
    .chip.working { background:#f3f4f6; }
    .card-b { padding:12px 16px; font-size:14px; }
    .row { display:grid; grid-template-columns: 1fr; gap:6px; margin:6px 0; }
    .row label { color:var(--muted); font-size:12px; }
    .actions { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .empty { margin-top:12px; padding:20px; font-size:14px; color:#4b5563; }
    .thanks { background:var(--warnbg); color:#3730a3; border:1px solid #c7d2fe; padding:10px 12px; border-radius:12px; margin:8px 0; font-size:13px; }
    .congrats { background:var(--okbg); color:var(--ok); border:1px solid #a7f3d0; padding:10px 12px; border-radius:12px; margin:8px 0; font-size:13px; }
    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; padding:16px; }
    .sheet { background:#fff; border-radius:16px; width:100%; max-width:720px; border:1px solid var(--border); }
    .sheet-h { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); }
    .sheet-b { padding:12px 16px; }
    .sheet-f { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end; }
    .steps { display:flex; align-items:center; gap:6px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#d1d5db; }
    .dot.on { background:#111; }
    .okbox { background:#f9fafb; color:#111; border:1px solid #e5e7eb; padding:10px 12px; border-radius:12px; margin-top:6px; position:relative; overflow:hidden; }
    .okflash { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(236,253,245,0.9); color:#065f46; font-weight:600; }
    .grid2 { display:grid; grid-template-columns: 1fr; gap:8px; }
    @media (min-width:640px){ .grid2 { grid-template-columns: 1 fr 1fr; } }
    /* UID modal */
    .dim { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; }
    .panel { background:#fff; border:1px solid var(--border); border-radius:16px; width:100%; max-width:520px; padding:16px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>æ‚©ã¿äº‹ â†’ æ„Ÿæƒ… â†’ æœ›ã‚€çŠ¶æ…‹ â†’ è§£æ±ºç­–</h1>
      <div class="muted">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ»CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</div>
      <div id="userTag" class="muted" style="margin-top:4px;"></div>
      <div id="thanks" class="thanks" style="display:none;">ä»Šæ—¥ã‚‚ä¸€æ—¥ã‚ã‚ŠãŒã¨ã†ï¼</div>
      <div id="congrats" class="congrats" style="display:none;">ğŸ‰ ã‚ˆãæ›¸ã‘ã¾ã—ãŸï¼ï¼ˆä¿å­˜å®Œäº†ï¼‰</div>
    </header>

    <div class="toolbar">
      <button class="btn primary" id="newBtn">æ–°è¦è¿½åŠ ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰</button>
      <button class="btn" id="csvBtn">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <div class="spacer"></div>
      <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆæ‚©ã¿äº‹ãƒ»æ„Ÿæƒ…ãƒ»è§£æ±ºç­–ãªã©ï¼‰" style="max-width:220px;" />
      <select class="select" id="filter">
        <option value="ALL">ã™ã¹ã¦</option>
        <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
        <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
        <option value="å®Œäº†">å®Œäº†</option>
      </select>
    </div>

    <div class="progress"><div class="bar" id="bar" style="width:0%"></div></div>
    <div class="muted" id="rate" style="margin:4px 0 12px;">å®Œäº†ç‡: 0%</div>

    <div id="list" class="grid"></div>
    <div id="empty" class="card empty" style="display:none;">å³ä¸Šã®ã€Œæ–°è¦è¿½åŠ ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰ã€ã‹ã‚‰ã€ã¾ãšã¯1ä»¶å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</div>
  </div>

  <!-- UID Setup Modal -->
  <div class="dim" id="uidModal">
    <div class="panel">
      <div style="font-weight:600; margin-bottom:8px;">ã‚ãªãŸå°‚ç”¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</div>
      <div class="muted" style="margin-bottom:10px;">åå‰ã‚„IDã‚’å…¥ã‚Œã¦ã€Œãƒªãƒ³ã‚¯ä½œæˆã€ã‚’æŠ¼ã™ã¨ã€ã“ã®ãƒšãƒ¼ã‚¸ãŒ <code>?u=â—¯â—¯</code> ä»˜ãã§é–‹ãã¾ã™ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹éš›ã¯ã€å¿…ãšãã®ãƒªãƒ³ã‚¯ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
      <input id="uidInput" class="input" placeholder="ä¾‹ï¼šhana / taro123 / ä»»æ„ã®ID" />
      <div class="actions" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn" id="uidCancel">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="uidMake">ãƒªãƒ³ã‚¯ä½œæˆ</button>
      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div class="modal" id="modal" style="display:none;">
    <div class="sheet">
      <div class="sheet-h">
        <div>æ®µéšå…¥åŠ›ã‚¬ã‚¤ãƒ‰</div>
        <button class="btn" id="closeModal" title="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="sheet-b">
        <div style="display:flex; align-items:center; justify-content:space-between; font-size:12px; color:#6b7280;">
          <div>ã‚¹ãƒ†ãƒƒãƒ— <span id="stepNow">1</span> / <span id="stepTotal">4</span></div>
          <div class="steps" id="stepDots"></div>
        </div>

        <div class="row" style="margin-top:10px;">
          <label id="fieldLabel">æ‚©ã¿äº‹ï¼ˆäº‹å®Ÿãƒ»çŠ¶æ³ï¼‰</label>
          <input id="fieldInput" class="input" placeholder="ä¾‹ï¼šAã•ã‚“ã¨ã®é¢è«‡æº–å‚™ãŒé€²ã‚“ã§ã„ãªã„" />
          <textarea id="fieldTextarea" class="textarea" style="display:none;" placeholder=""></textarea>
        </div>

        <div id="okBox" class="okbox" style="display:none;">
          <div style="font-size:12px;">æ¬¡ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ</div>
          <div class="actions" style="margin-top:6px;">
            <button class="btn primary" id="yesBtn">ã¯ã„</button>
            <button class="btn" id="noBtn">ã„ã„ãˆ</button>
          </div>
          <div id="okFlash" class="okflash">ğŸ‰ ã‚ˆãæ›¸ã‘ã¾ã—ãŸï¼</div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="row">
            <label>æ—¥ä»˜</label>
            <input id="dateInput" type="date" class="input" />
          </div>
          <div class="row">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="statusInput" class="select">
              <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
              <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
              <option value="å®Œäº†">å®Œäº†</option>
            </select>
          </div>
        </div>
      </div>
      <div class="sheet-f">
        <button class="btn" id="cancelBtn">é–‰ã˜ã‚‹</button>
        <button class="btn primary" id="saveBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    let LS_KEY = "worry_sheet_v1"; // will be replaced with per-user key
    const EOL = "\\r\\n";
    let items = [];
    let filter = "ALL";
    let q = "";
    let editing = null;
    let guideStep = 0; // 0:æ‚©ã¿ 1:æ„Ÿæƒ… 2:æœ›ã‚€ 3:å…·ä½“ç­–
    let isStepping = false;

    const steps = [
      { key: "worry",   label: "æ‚©ã¿äº‹ï¼ˆäº‹å®Ÿãƒ»çŠ¶æ³ï¼‰", placeholder: "ä¾‹ï¼šAã•ã‚“ã¨ã®é¢è«‡æº–å‚™ãŒé€²ã‚“ã§ã„ãªã„", type: "input" },
      { key: "feeling", label: "ãã‚Œã«å¯¾ã™ã‚‹æ„Ÿæƒ…",     placeholder: "ä¾‹ï¼šä¸å®‰ã€ç„¦ã‚Šã€ã‚‚ã‚„ã‚‚ã‚„",         type: "input" },
      { key: "desire",  label: "æ‚©ã¿äº‹ã‚’ã©ã†ã—ãŸã„ã‹ï¼ˆæœ›ã‚€çŠ¶æ…‹ï¼‰", placeholder: "ä¾‹ï¼šé¢è«‡å‰ã«è«–ç‚¹æ•´ç†ãŒã§ãã¦è½ã¡ç€ã„ã¦è‡¨ã‚ã¦ã„ã‚‹", type: "textarea" },
      { key: "solution",label: "å…·ä½“çš„ãªè§£æ±ºç­–ï¼ˆãƒ—ãƒ©ãƒ³ï¼‰", placeholder: "ä¾‹ï¼šâ‘ ç›®çš„ã¨è«–ç‚¹ã‚’3ã¤ã«æ•´ç† â‘¡è³‡æ–™åé›† â‘¢æœãƒªãƒãƒ¼ã‚µãƒ«", type: "textarea" },
    ];

    // Elements
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const barEl = document.getElementById("bar");
    const rateEl = document.getElementById("rate");
    const newBtn = document.getElementById("newBtn");
    const csvBtn = document.getElementById("csvBtn");
    const qEl = document.getElementById("q");
    const filterEl = document.getElementById("filter");
    const thanksEl = document.getElementById("thanks");
    const congratsEl = document.getElementById("congrats");
    const userTag = document.getElementById("userTag");
    // UID modal
    const uidModal = document.getElementById("uidModal");
    const uidInput = document.getElementById("uidInput");
    const uidMake = document.getElementById("uidMake");
    const uidCancel = document.getElementById("uidCancel");

    // Guide modal elements
    const modalEl = document.getElementById("modal");
    const closeModal = document.getElementById("closeModal");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");
    const stepNow = document.getElementById("stepNow");
    const stepTotal = document.getElementById("stepTotal");
    const stepDots = document.getElementById("stepDots");
    const fieldLabel = document.getElementById("fieldLabel");
    const fieldInput = document.getElementById("fieldInput");
    const fieldTextarea = document.getElementById("fieldTextarea");
    const yesBtn = document.getElementById("yesBtn");
    const noBtn = document.getElementById("noBtn");
    const okBox = document.getElementById("okBox");
    const okFlash = document.getElementById("okFlash");
    const dateInput = document.getElementById("dateInput");
    const statusInput = document.getElementById("statusInput");

    function params(){ return new URLSearchParams(location.search); }
    function uidFromURL(){ return params().get("u") || ""; }

    function setUid(uid){
      const p = params();
      p.set("u", uid);
      location.replace(location.pathname + "?" + p.toString());
    }

    function ensureUid(){
      let uid = uidFromURL();
      if(!uid){
        uidModal.style.display = "flex";
        userTag.textContent = "ï¼ˆå°‚ç”¨IDãŒæœªè¨­å®šã§ã™ï¼‰";
      }else{
        uidModal.style.display = "none";
        userTag.textContent = "ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€Œ" + uid + "ã€ã•ã‚“ç”¨";
      }
      return uid;
    }

    function uidify(s){
      return String(s).trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "-").replace(/^-+|-+$/g,"").slice(0,40) || "user";
    }

    function uidInit(){
      const uid = ensureUid();
      if(!uid) return false;
      LS_KEY = "worry_sheet_" + uid;
      return true;
    }

    function today(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return d.getFullYear()+"-"+mm+"-"+dd;
    }

    function load(){
      try { items = JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch(e){ items=[]; }
    }
    function save(){
      try { localStorage.setItem(LS_KEY, JSON.stringify(items)); } catch(e){}
    }

    function escapeCell(v){
      const s = (v==null?"":String(v)).replace(/\"/g,'\"\"');
      return "\""+s+"\"";
    }
    function exportCSV(rows){
      const header = ["æ—¥ä»˜","æ‚©ã¿äº‹ï¼ˆäº‹å®Ÿãƒ»çŠ¶æ³ï¼‰","ãã‚Œã«å¯¾ã™ã‚‹æ„Ÿæƒ…","æ‚©ã¿äº‹ã‚’ã©ã†ã—ãŸã„ã‹ï¼ˆæœ›ã‚€çŠ¶æ…‹ï¼‰","å…·ä½“çš„ãªè§£æ±ºç­–ï¼ˆãƒ—ãƒ©ãƒ³ï¼‰","ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"];
      const lines = rows.map(r => [r.date,r.worry,r.feeling,r.desire,r.solution,r.status].map(escapeCell).join(","));
      const csv = [header.map(escapeCell).join(","), ...lines].join(EOL);
      const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "æ‚©ã¿äº‹ã‚·ãƒ¼ãƒˆ_"+today()+".csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function filtered(){
      let base = items;
      if(filter !== "ALL") base = base.filter(i => i.status === filter);
      const needle = q.trim().toLowerCase();
      if(!needle) return base;
      return base.filter(i => [i.worry,i.feeling,i.desire,i.solution].some(v => (v||"").toLowerCase().includes(needle)));
    }

    function renderProgress(){
      if(items.length===0){ barEl.style.width="0%"; rateEl.textContent="å®Œäº†ç‡: 0%"; return; }
      const done = items.filter(i=>i.status==="å®Œäº†").length;
      const pct = Math.round(done/items.length*100);
      barEl.style.width = pct+"%";
      rateEl.textContent = "å®Œäº†ç‡: "+pct+"%";
    }

    function escapeHTML(s){
      s = String(s);
      return s.replace(/[&<>\"']/g, function(c){
        if (c === '&') return '&amp;';
        if (c === '<') return '&lt;';
        if (c === '>') return '&gt;';
        if (c === '"') return '&quot;';
        return '&#39;';
      });
    }

    function renderList(){
      const list = filtered();
      listEl.innerHTML = "";
      if(list.length===0){
        emptyEl.style.display = items.length===0 ? "block" : "none";
      } else {
        emptyEl.style.display = "none";
      }
      list.forEach(it => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-h">
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="chip ${it.status==="å®Œäº†"?"done":(it.status==="é€²è¡Œä¸­"?"working":"")}">${it.status}</span>
              <div style="font-weight:600;">${escapeHTML(it.worry || "ï¼ˆç„¡é¡Œï¼‰")}</div>
            </div>
            <div class="muted">${escapeHTML(it.date || "")}</div>
          </div>
          <div class="card-b">
            <div class="row"><label>æ„Ÿæƒ…</label><div>${escapeHTML(it.feeling||"")}</div></div>
            <div class="row"><label>ã©ã†ã—ãŸã„ï¼ˆæœ›ã‚€çŠ¶æ…‹ï¼‰</label><div>${escapeHTML(it.desire||"")}</div></div>
            <div class="row"><label>å…·ä½“çš„ãªè§£æ±ºç­–</label><div style="white-space:pre-wrap">${escapeHTML(it.solution||"")}</div></div>
            <div class="actions">
              <button class="btn" data-act="edit">ç·¨é›†ï¼ˆã‚¬ã‚¤ãƒ‰ï¼‰</button>
              <button class="btn danger" data-act="del">å‰Šé™¤</button>
              ${it.status!=="å®Œäº†"?'<button class="btn primary" data-act="done">å®Œäº†ã«ã™ã‚‹</button>':""}
            </div>
          </div>
        `;
        card.querySelector('[data-act="edit"]').addEventListener("click", ()=> { editing = {...it}; guideStep=0; openModal(); });
        card.querySelector('[data-act="del"]').addEventListener("click", ()=> { items = items.filter(p=>p.id!==it.id); save(); renderAll(); });
        const doneBtn = card.querySelector('[data-act="done"]');
        if(doneBtn){ doneBtn.addEventListener("click", ()=> { it.status="å®Œäº†"; save(); renderAll(); }); }
        listEl.appendChild(card);
      });
    }

    function renderAll(){
      renderList();
      renderProgress();
    }

    // ---- Modal / Guide ----
    function openModal(){
      if(!editing){
        editing = { id:"tmp", date: today(), worry:"", feeling:"", desire:"", solution:"", status:"æœªç€æ‰‹" };
        guideStep = 0;
      }
      stepTotal.textContent = String(steps.length);
      updateStepUI();
      modalEl.style.display = "flex";
    }
    function closeModalFn(){ modalEl.style.display="none"; editing=null; }

    function updateStepUI(){
      stepNow.textContent = String(guideStep+1);
      stepDots.innerHTML = "";
      steps.forEach((_,i)=>{
        const d = document.createElement("div");
        d.className = "dot"+(i<=guideStep?" on":"");
        stepDots.appendChild(d);
      });

      const step = steps[guideStep];
      fieldLabel.textContent = step.label;
      fieldInput.style.display = step.type === "input" ? "block" : "none";
      fieldTextarea.style.display = step.type === "textarea" ? "block" : "none";
      const val = editing[step.key] || "";
      if(step.type==="input"){
        fieldInput.value = val;
        fieldInput.placeholder = step.placeholder;
      } else {
        fieldTextarea.value = val;
        fieldTextarea.placeholder = step.placeholder;
      }
      okBox.style.display = String(val).trim().length > 0 ? "block" : "none";
      okFlash.style.display = "none";

      dateInput.value = editing.date || today();
      statusInput.value = editing.status || "æœªç€æ‰‹";
      isStepping = false;
    }

    function setCurrentValue(v){
      const key = steps[guideStep].key;
      editing[key] = v;
      const show = String(v).trim().length>0;
      okBox.style.display = show ? "block" : "none";
      okFlash.style.display = "none";
    }

    function stepCongratsThenNext(){
      if(isStepping) return;
      isStepping = true;
      okFlash.style.display = "flex";
      yesBtn.setAttribute("disabled","true");
      noBtn.setAttribute("disabled","true");
      setTimeout(()=>{
        okFlash.style.display = "none";
        yesBtn.removeAttribute("disabled");
        noBtn.removeAttribute("disabled");
        if(guideStep < steps.length-1){
          guideStep++;
          updateStepUI();
        } else {
          doSave(true);
        }
      }, 800);
    }

    function doSave(showCongrats){
      if(!editing.worry || !editing.feeling || !editing.desire || !editing.solution){
        alert("å¿…é ˆé …ç›®ï¼ˆ4ã¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        isStepping = false;
        return;
      }
      const payload = {...editing};
      delete payload.id;
      if(editing.id==="tmp"){
        payload.id = Math.random().toString(36).slice(2) + Date.now().toString(36);
        items = [payload, ...items];
      }else{
        payload.id = editing.id;
        items = items.map(p => p.id===payload.id ? payload : p);
      }
      save(); renderAll(); closeModalFn();
      if(showCongrats){
        congratsEl.style.display="block";
        setTimeout(()=>{ congratsEl.style.display="none"; }, 3000);
      }
      isStepping = false;
    }

    function saveNow(){ doSave(true); }

    function saveDraftAndThanks(){
      const payload = {...editing};
      delete payload.id;
      if(editing.id==="tmp"){
        payload.id = Math.random().toString(36).slice(2) + Date.now().toString(36);
        items = [payload, ...items];
      }else{
        payload.id = editing.id;
        items = items.map(p => p.id===payload.id ? payload : p);
      }
      save(); renderAll(); closeModalFn();
      thanksEl.style.display="block";
      setTimeout(()=>{ thanksEl.style.display="none"; }, 3000);
    }

    // Events
    newBtn.addEventListener("click", ()=>{ editing=null; openModal(); });
    csvBtn.addEventListener("click", ()=> exportCSV(filtered()) );
    qEl.addEventListener("input", (e)=>{ q=e.target.value; renderAll(); });
    filterEl.addEventListener("change", (e)=>{ filter=e.target.value; renderAll(); });

    closeModal.addEventListener("click", closeModalFn);
    cancelBtn.addEventListener("click", closeModalFn);
    saveBtn.addEventListener("click", saveNow);

    fieldInput.addEventListener("input", (e)=> setCurrentValue(e.target.value));
    fieldTextarea.addEventListener("input", (e)=> setCurrentValue(e.target.value));

    yesBtn.addEventListener("click", stepCongratsThenNext);
    noBtn.addEventListener("click", saveDraftAndThanks);

    dateInput.addEventListener("change", (e)=>{ editing.date = e.target.value; });
    statusInput.addEventListener("change", (e)=>{ editing.status = e.target.value; });

    // UID modal handlers
    uidMake.addEventListener("click", ()=>{
      const raw = uidInput.value;
      const id = String(raw).trim();
      if(!id){ alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      const slug = id.toLowerCase().replace(/[^a-z0-9_-]+/g, "-").replace(/^-+|-+$/g,"").slice(0,40) || "user";
      const p = new URLSearchParams(location.search);
      p.set("u", slug);
      location.replace(location.pathname + "?" + p.toString());
    });
    uidCancel.addEventListener("click", ()=>{ uidModal.style.display = "none"; });

    // Init
    if(uidInit()){
      load();
      renderAll();
    }
  })();
  </script>
</body>
</html>
